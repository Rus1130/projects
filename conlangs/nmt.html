<head>

</head>
<body>
    <div id="out" style="font-family: monospace"></div>
    <button id="ortho" style="padding: 10px;">copy ortho</button>
    <button id="ipa" style="padding: 10px;">copy IPA</button>
</body>
<script>
    // get query strings
    let urlParams = new URLSearchParams(window.location.search);
    // get the param called "s"
    let type = urlParams.get('t');
    let s = urlParams.get('s');

    function ipa(s){
        s = delim(s);
        const r = [
            [   
                // replace combining vowels with their combined counterparts
                { pattern: "á", value: "á" },
                { pattern: "é", value: "é" },
                { pattern: "í", value: "í" },
                { pattern: "ó", value: "ó" },
                { pattern: "ú", value: "ú" },
                { pattern: "ä", value: "ä" },
                { pattern: "ë", value: "ë" },
                { pattern: "ü", value: "ü" },

                { pattern: "ngg", value: "ᵑg" },
            ],
            [
                // delimiters 
                { pattern: "ā", value: "a‿"},
                { pattern: "c", value: "‿"},
                { pattern: "ə", value: "‿"},
                { pattern: "z", value: "‿"},

                // consonants
                { pattern: 'ng', value: "ŋ" },
                { pattern: 'y', value: "j" },
                { pattern: "gy", value: "c"},
                { pattern: "'", value: "ʔ" },
                { pattern: "nd", value: "ⁿd" },
                { pattern: "mb", value: "ᵐb" },
                { pattern: "ts", value: "t͡s" },

                // vowels
                { pattern: 'a', value: "a." },
                { pattern: 'e', value: "e." },
                { pattern: 'i', value: "i." },
                { pattern: 'o', value: "o." },
                { pattern: 'u', value: "u." },
                { pattern: 'á', value: "aː." },
                { pattern: 'é', value: "eː." },
                { pattern: 'í', value: "iː." },
                { pattern: 'ó', value: "oː." },
                { pattern: 'ú', value: "uː." },
                { pattern: 'är', value: "ɑː." },
                { pattern: 'ä', value: "ɑ." },
                { pattern: 'ë', value: "ə." },
                { pattern: 'ü', value: "y." },
            ],
            [
                { pattern: ".‿", value: "‿"},
                { pattern: "a.o", value: "ao̯"},
                { pattern: "e.o", value: "eo̯"},
                { pattern: ".,", value: " |"},
            ]
        ]

        const v = ["a", "e", "i", "o", "u", "ː", "ɑ", "ə", "y"]
        const c = ["b", "d", "f", "g", "h", "k", "l", "m", "n", "p", "s", "t", "v", "w", "j", "c", "ŋ", "ʔ"]

        const map = m => Object.fromEntries(m.map(({ pattern, value }) => [pattern, value]))

        // teng%20kaoki%20túwus%20süm%20ken%20tsi%27an%20bëm%20nam%20fasu%27i%27an%20tsuti%27an


        let result = s.replace(new RegExp(Object.keys(map(r[0])).join("|"), "g"), match => map(r[0])[match] || match)
        result = result.replace(new RegExp(Object.keys(map(r[1])).join("|"), "g"), match => map(r[1])[match] || match)
        result = result.replace(new RegExp(Object.keys(map(r[2])).join("|"), "g"), match => map(r[2])[match] || match)

        result = result.split(" ")
        result.forEach((index, i) => {
            if(result[i][result[i].length - 1] == ".") {
                result[i] = result[i].substring(0, result[i].length - 1)
            }
        });

        const V = "["+v.join("")+"]";
        const C = "["+c.join("")+"]";

        result.forEach((index, i) => {
            let split = result[i].split(".");
            
            // fix delimited syllable boundaries 
            result[i] = index.replaceAll(new RegExp(`(${C}${V})(\.)(${C})(‿)`, "g"), "$1$3$4")   

            // fix non-delimited syllable boundaries
            result[i] = result[i].replaceAll(new RegExp(`(${C}${V})(\.)(${C})$`, "g"), "$1$3") 

            // fix nasal syllable boundaries le.ŋki -> leŋ.ki
            result[i] = result[i].replaceAll(new RegExp(`(\.)([mn̪ŋ])(${C})`, "g"), "$2.$3")  

            // fix velar prenasalized syllable boundaries
            //result[i] = result[i].replaceAll(new RegExp(`\.ŋg`, "g"), "ᵑg\.");
        })

        return result = ("/"+result.join(" ").replaceAll("n", "n̪").replaceAll("| ", " | ").replaceAll(". ", " || ")+"/").replaceAll(".​", "");
    }

    function delim(s){
        const V = ["a", "e", "i", "o", "u", "á", "é", "í", "ó", "ú", "ä", "ë", "ü"]
        const C = ["b", "d", "f", "g", "h", "k", "l", "m", "n", "p", "s", "t", "v", "w", "y", "r"]
        const C1 = ["m", "n", "s", "v", "w", "r"]
        const A = ["b", "d", "f", "h", "k", "l", "t"]
        const D = ["g", "p", "y"]
        const P = ["o", "i", "u"]


        for(let i = 0; i < s.length; i++){

            if(s[i] == "-"){
                let left = s[i-1]
                let right = s[i+1]
                
                // C-C = ə
                // P-C = ə
                // V-V = c
                // V-C1 = z
                // V-D = c
                // V-A = z
                // a-C = ā

                if(left == "a" && C.includes(right)) {
                    s = s.substring(0, i) + "ā" + s.substring(i+1)
                    continue
                }
                if(V.includes(left) && D.includes(right)) {
                    s = s.substring(0, i) + "c" + s.substring(i+1)
                    continue
                }
                if(P.includes(left) && C.includes(right)) {
                    s = s.substring(0, i) + "ə" + s.substring(i+1)
                    continue
                }
                if(C.includes(left) && C.includes(right)) {
                    s = s.substring(0, i) + "ə" + s.substring(i+1)
                    continue
                }
                if(V.includes(left) && V.includes(right)) {
                    s = s.substring(0, i) + "c" + s.substring(i+1)
                    continue
                }
                if(V.includes(left) && C1.includes(right)) {
                    s = s.substring(0, i) + "z" + s.substring(i+1)
                    continue
                }
                if(V.includes(left) && A.includes(right)) {
                    s = s.substring(0, i) + "z" + s.substring(i+1)
                    continue
                }
            }
        }

        s = s.replaceAll("aā", "ā")
        return s;
    }

    let result = delim(s) + "\n" + ipa(s);

    document.getElementById("out").innerText = result;

    document.getElementById("ortho").addEventListener("click", function(){
        navigator.clipboard.writeText(delim(s));
    })

    document.getElementById("ipa").addEventListener("click", function(){
        navigator.clipboard.writeText(ipa(s));
    })
</script>